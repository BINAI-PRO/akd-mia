-- WARNING: This schema is for context only and is not meant to be run.
-- Table order and constraints may not be valid for execution.

CREATE TABLE public.admin_permissions (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  code text NOT NULL UNIQUE,
  description text NOT NULL,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT admin_permissions_pkey PRIMARY KEY (id)
);
CREATE TABLE public.apparatus (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  name text NOT NULL,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT apparatus_pkey PRIMARY KEY (id)
);
CREATE TABLE public.booking_events (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  booking_id uuid NOT NULL,
  actor_client_id uuid,
  actor_staff_id uuid,
  actor_instructor_id uuid,
  event_type text NOT NULL CHECK (event_type = ANY (ARRAY['CREATED'::text, 'CANCELLED'::text, 'REBOOKED'::text, 'CHECKED_IN'::text, 'CHECKED_OUT'::text])),
  notes text,
  metadata jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT booking_events_pkey PRIMARY KEY (id),
  CONSTRAINT booking_events_booking_id_fkey FOREIGN KEY (booking_id) REFERENCES public.bookings(id),
  CONSTRAINT booking_events_actor_client_id_fkey FOREIGN KEY (actor_client_id) REFERENCES public.clients(id),
  CONSTRAINT booking_events_actor_staff_id_fkey FOREIGN KEY (actor_staff_id) REFERENCES public.staff(id),
  CONSTRAINT booking_events_actor_instructor_id_fkey FOREIGN KEY (actor_instructor_id) REFERENCES public.instructors(id)
);
CREATE TABLE public.booking_notifications (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  booking_id uuid NOT NULL,
  notification_type text NOT NULL CHECK (notification_type = ANY (ARRAY['EMAIL'::text, 'PUSH'::text])),
  deliver_at timestamp with time zone NOT NULL,
  delivered_at timestamp with time zone,
  payload jsonb NOT NULL,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT booking_notifications_pkey PRIMARY KEY (id),
  CONSTRAINT booking_notifications_booking_id_fkey FOREIGN KEY (booking_id) REFERENCES public.bookings(id)
);
CREATE TABLE public.bookings (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  session_id uuid NOT NULL,
  client_id uuid NOT NULL,
  apparatus_id uuid,
  status USER-DEFINED NOT NULL DEFAULT 'CONFIRMED'::booking_status,
  reserved_at timestamp with time zone NOT NULL DEFAULT now(),
  cancelled_at timestamp with time zone,
  cancelled_by uuid,
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  rebooked_from_booking_id uuid,
  plan_purchase_id uuid,
  CONSTRAINT bookings_pkey PRIMARY KEY (id),
  CONSTRAINT bookings_session_id_fkey FOREIGN KEY (session_id) REFERENCES public.sessions(id),
  CONSTRAINT bookings_client_id_fkey FOREIGN KEY (client_id) REFERENCES public.clients(id),
  CONSTRAINT bookings_apparatus_id_fkey FOREIGN KEY (apparatus_id) REFERENCES public.apparatus(id),
  CONSTRAINT bookings_cancelled_by_fkey FOREIGN KEY (cancelled_by) REFERENCES public.clients(id),
  CONSTRAINT bookings_rebooked_from_booking_id_fkey FOREIGN KEY (rebooked_from_booking_id) REFERENCES public.bookings(id),
  CONSTRAINT bookings_plan_purchase_id_fkey FOREIGN KEY (plan_purchase_id) REFERENCES public.plan_purchases(id)
);
CREATE TABLE public.class_types (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  name text NOT NULL UNIQUE,
  description text,
  intensity USER-DEFINED,
  target_audience text,
  CONSTRAINT class_types_pkey PRIMARY KEY (id)
);
CREATE TABLE public.client_profiles (
  client_id uuid NOT NULL,
  status USER-DEFINED NOT NULL DEFAULT 'ACTIVE'::client_status,
  avatar_url text,
  birthdate date,
  occupation text,
  notes text,
  emergency_contact_name text,
  emergency_contact_phone text,
  preferred_apparatus ARRAY NOT NULL DEFAULT '{}'::text[],
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_by_client_at timestamp with time zone,
  avatar_storage_path text,
  CONSTRAINT client_profiles_pkey PRIMARY KEY (client_id),
  CONSTRAINT client_profiles_client_id_fkey FOREIGN KEY (client_id) REFERENCES public.clients(id)
);
CREATE TABLE public.clients (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  full_name text NOT NULL,
  phone text,
  email text UNIQUE,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  auth_user_id uuid UNIQUE,
  CONSTRAINT clients_pkey PRIMARY KEY (id)
);
CREATE TABLE public.courses (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  title text NOT NULL,
  slug text UNIQUE,
  description text,
  short_description text,
  price numeric,
  currency text NOT NULL DEFAULT 'MXN'::text,
  duration_label text,
  level USER-DEFINED DEFAULT 'Multinivel'::course_level,
  category USER-DEFINED,
  visibility USER-DEFINED NOT NULL DEFAULT 'PUBLIC'::course_visibility,
  status USER-DEFINED NOT NULL DEFAULT 'DRAFT'::course_status,
  tags ARRAY NOT NULL DEFAULT '{}'::text[],
  cover_image_url text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  session_count integer NOT NULL,
  session_duration_minutes integer NOT NULL,
  lead_instructor_id uuid,
  class_type_id uuid,
  default_room_id uuid,
  booking_window_days integer DEFAULT 7 CHECK (booking_window_days >= 0),
  cancellation_window_hours integer NOT NULL DEFAULT 24,
  CONSTRAINT courses_pkey PRIMARY KEY (id),
  CONSTRAINT courses_lead_instructor_id_fkey FOREIGN KEY (lead_instructor_id) REFERENCES public.instructors(id),
  CONSTRAINT courses_class_type_id_fkey FOREIGN KEY (class_type_id) REFERENCES public.class_types(id),
  CONSTRAINT courses_default_room_id_fkey FOREIGN KEY (default_room_id) REFERENCES public.rooms(id)
);
CREATE TABLE public.instructor_class_types (
  instructor_id uuid NOT NULL,
  class_type_id uuid NOT NULL,
  certified boolean NOT NULL DEFAULT true,
  certified_at timestamp with time zone,
  notes text,
  CONSTRAINT instructor_class_types_pkey PRIMARY KEY (instructor_id, class_type_id),
  CONSTRAINT instructor_class_types_instructor_id_fkey FOREIGN KEY (instructor_id) REFERENCES public.instructors(id),
  CONSTRAINT instructor_class_types_class_type_id_fkey FOREIGN KEY (class_type_id) REFERENCES public.class_types(id)
);
CREATE TABLE public.instructor_week_override_slots (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  override_id uuid NOT NULL,
  weekday smallint NOT NULL CHECK (weekday >= 0 AND weekday <= 6),
  start_time time without time zone NOT NULL,
  end_time time without time zone NOT NULL,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT instructor_week_override_slots_pkey PRIMARY KEY (id),
  CONSTRAINT instructor_week_override_slots_override_id_fkey FOREIGN KEY (override_id) REFERENCES public.instructor_week_overrides(id)
);
CREATE TABLE public.instructor_week_overrides (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  instructor_id uuid NOT NULL,
  week_start_date date NOT NULL,
  label text,
  notes text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT instructor_week_overrides_pkey PRIMARY KEY (id),
  CONSTRAINT instructor_week_overrides_instructor_id_fkey FOREIGN KEY (instructor_id) REFERENCES public.instructors(id)
);
CREATE TABLE public.instructor_weekly_availability (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  instructor_id uuid NOT NULL,
  weekday smallint NOT NULL CHECK (weekday >= 0 AND weekday <= 6),
  start_time time without time zone NOT NULL,
  end_time time without time zone NOT NULL,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT instructor_weekly_availability_pkey PRIMARY KEY (id),
  CONSTRAINT instructor_weekly_availability_instructor_id_fkey FOREIGN KEY (instructor_id) REFERENCES public.instructors(id)
);
CREATE TABLE public.instructors (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  full_name text NOT NULL,
  bio text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  email text,
  phone1 text,
  phone2 text,
  phone1_has_whatsapp boolean,
  phone2_has_whatsapp boolean,
  nick text,
  CONSTRAINT instructors_pkey PRIMARY KEY (id)
);
CREATE TABLE public.membership_payments (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  membership_id uuid NOT NULL,
  amount numeric NOT NULL CHECK (amount >= 0::numeric),
  currency text NOT NULL DEFAULT 'MXN'::text,
  paid_at timestamp with time zone NOT NULL DEFAULT now(),
  period_start date NOT NULL,
  period_end date NOT NULL,
  status USER-DEFINED NOT NULL DEFAULT 'SUCCESS'::payment_status,
  provider_ref text,
  notes text,
  period_years integer NOT NULL DEFAULT 1 CHECK (period_years >= 1),
  CONSTRAINT membership_payments_pkey PRIMARY KEY (id),
  CONSTRAINT membership_payments_membership_id_fkey FOREIGN KEY (membership_id) REFERENCES public.memberships(id)
);
CREATE TABLE public.membership_types (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  name text NOT NULL UNIQUE,
  description text,
  billing_period USER-DEFINED NOT NULL,
  access_type USER-DEFINED NOT NULL,
  price numeric NOT NULL CHECK (price >= 0::numeric),
  currency text NOT NULL DEFAULT 'MXN'::text,
  class_quota integer CHECK (class_quota >= 0),
  is_active boolean NOT NULL DEFAULT true,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  trial_days integer,
  access_classes boolean NOT NULL DEFAULT true,
  access_courses boolean NOT NULL DEFAULT false,
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  privileges text,
  max_prepaid_years integer,
  allow_multi_year boolean NOT NULL DEFAULT true,
  CONSTRAINT membership_types_pkey PRIMARY KEY (id)
);
CREATE TABLE public.memberships (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  client_id uuid NOT NULL,
  membership_type_id uuid NOT NULL,
  status USER-DEFINED NOT NULL DEFAULT 'ACTIVE'::membership_status,
  start_date date NOT NULL DEFAULT (now())::date,
  end_date date NOT NULL,
  next_billing_date date,
  auto_renew boolean NOT NULL DEFAULT true,
  assigned_session_id uuid,
  remaining_classes integer CHECK (remaining_classes >= 0),
  notes text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  term_years integer NOT NULL DEFAULT 1 CHECK (term_years >= 1),
  privileges_snapshot text,
  CONSTRAINT memberships_pkey PRIMARY KEY (id),
  CONSTRAINT memberships_client_id_fkey FOREIGN KEY (client_id) REFERENCES public.clients(id),
  CONSTRAINT memberships_membership_type_id_fkey FOREIGN KEY (membership_type_id) REFERENCES public.membership_types(id),
  CONSTRAINT memberships_assigned_session_id_fkey FOREIGN KEY (assigned_session_id) REFERENCES public.sessions(id)
);
CREATE TABLE public.plan_payments (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  plan_purchase_id uuid NOT NULL,
  amount numeric NOT NULL CHECK (amount >= 0::numeric),
  currency text NOT NULL DEFAULT 'MXN'::text,
  paid_at timestamp with time zone NOT NULL DEFAULT now(),
  status USER-DEFINED NOT NULL DEFAULT 'SUCCESS'::payment_status,
  provider_ref text,
  notes text,
  CONSTRAINT plan_payments_pkey PRIMARY KEY (id),
  CONSTRAINT plan_payments_plan_purchase_id_fkey FOREIGN KEY (plan_purchase_id) REFERENCES public.plan_purchases(id)
);
CREATE TABLE public.plan_purchases (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  client_id uuid NOT NULL,
  plan_type_id uuid NOT NULL,
  status USER-DEFINED NOT NULL DEFAULT 'ACTIVE'::plan_status,
  purchased_at timestamp with time zone NOT NULL DEFAULT now(),
  start_date date NOT NULL DEFAULT (now())::date,
  expires_at date,
  initial_classes integer NOT NULL CHECK (initial_classes >= 0),
  remaining_classes integer NOT NULL CHECK (remaining_classes >= 0),
  notes text,
  modality text DEFAULT 'FLEXIBLE'::text CHECK (modality = ANY (ARRAY['FIXED'::text, 'FLEXIBLE'::text])),
  CONSTRAINT plan_purchases_pkey PRIMARY KEY (id),
  CONSTRAINT plan_purchases_client_id_fkey FOREIGN KEY (client_id) REFERENCES public.clients(id),
  CONSTRAINT plan_purchases_plan_type_id_fkey FOREIGN KEY (plan_type_id) REFERENCES public.plan_types(id)
);
CREATE TABLE public.plan_types (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  name text NOT NULL,
  description text,
  privileges text,
  class_count integer NOT NULL CHECK (class_count > 0),
  price numeric NOT NULL CHECK (price >= 0::numeric),
  currency text NOT NULL DEFAULT 'MXN'::text,
  validity_days integer,
  is_active boolean NOT NULL DEFAULT true,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT plan_types_pkey PRIMARY KEY (id)
);
CREATE TABLE public.plan_usages (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  plan_purchase_id uuid NOT NULL,
  session_id uuid NOT NULL,
  used_at timestamp with time zone NOT NULL DEFAULT now(),
  credit_delta integer NOT NULL DEFAULT 1,
  notes text,
  CONSTRAINT plan_usages_pkey PRIMARY KEY (id),
  CONSTRAINT plan_usages_plan_purchase_id_fkey FOREIGN KEY (plan_purchase_id) REFERENCES public.plan_purchases(id),
  CONSTRAINT plan_usages_session_id_fkey FOREIGN KEY (session_id) REFERENCES public.sessions(id)
);
CREATE TABLE public.qr_tokens (
  booking_id uuid NOT NULL,
  token text NOT NULL UNIQUE,
  expires_at timestamp with time zone NOT NULL,
  CONSTRAINT qr_tokens_pkey PRIMARY KEY (booking_id),
  CONSTRAINT qr_tokens_booking_id_fkey FOREIGN KEY (booking_id) REFERENCES public.bookings(id)
);
CREATE TABLE public.room_apparatus (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  room_id uuid NOT NULL,
  apparatus_id uuid NOT NULL,
  quantity integer NOT NULL CHECK (quantity >= 0),
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT room_apparatus_pkey PRIMARY KEY (id),
  CONSTRAINT room_apparatus_room_id_fkey FOREIGN KEY (room_id) REFERENCES public.rooms(id),
  CONSTRAINT room_apparatus_apparatus_id_fkey FOREIGN KEY (apparatus_id) REFERENCES public.apparatus(id)
);
CREATE TABLE public.room_blocks (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  room_id uuid NOT NULL,
  starts_at timestamp with time zone NOT NULL,
  ends_at timestamp with time zone NOT NULL,
  reason text,
  note text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT room_blocks_pkey PRIMARY KEY (id),
  CONSTRAINT room_blocks_room_id_fkey FOREIGN KEY (room_id) REFERENCES public.rooms(id)
);
CREATE TABLE public.room_recurring_blocks (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  room_id uuid NOT NULL,
  weekday smallint NOT NULL CHECK (weekday >= 0 AND weekday <= 6),
  start_time time without time zone NOT NULL,
  end_time time without time zone NOT NULL,
  reason text,
  note text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT room_recurring_blocks_pkey PRIMARY KEY (id),
  CONSTRAINT room_recurring_blocks_room_id_fkey FOREIGN KEY (room_id) REFERENCES public.rooms(id)
);
CREATE TABLE public.rooms (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  name text NOT NULL,
  capacity integer NOT NULL CHECK (capacity > 0),
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  location text,
  CONSTRAINT rooms_pkey PRIMARY KEY (id)
);
CREATE TABLE public.session_apparatus (
  session_id uuid NOT NULL,
  apparatus_id uuid NOT NULL,
  quantity integer NOT NULL CHECK (quantity >= 0),
  CONSTRAINT session_apparatus_pkey PRIMARY KEY (session_id, apparatus_id),
  CONSTRAINT session_apparatus_session_id_fkey FOREIGN KEY (session_id) REFERENCES public.sessions(id),
  CONSTRAINT session_apparatus_apparatus_id_fkey FOREIGN KEY (apparatus_id) REFERENCES public.apparatus(id)
);
CREATE TABLE public.session_waitlist (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  session_id uuid NOT NULL,
  client_id uuid NOT NULL,
  position integer NOT NULL,
  status text NOT NULL CHECK (status = ANY (ARRAY['PENDING'::text, 'PROMOTED'::text, 'CANCELLED'::text])),
  notified_at timestamp with time zone,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT session_waitlist_pkey PRIMARY KEY (id),
  CONSTRAINT session_waitlist_session_id_fkey FOREIGN KEY (session_id) REFERENCES public.sessions(id),
  CONSTRAINT session_waitlist_client_id_fkey FOREIGN KEY (client_id) REFERENCES public.clients(id)
);
CREATE TABLE public.sessions (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  class_type_id uuid NOT NULL,
  room_id uuid NOT NULL,
  instructor_id uuid NOT NULL,
  start_time timestamp with time zone NOT NULL,
  end_time timestamp with time zone NOT NULL,
  capacity integer NOT NULL CHECK (capacity > 0),
  current_occupancy integer NOT NULL DEFAULT 0,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  course_id uuid,
  CONSTRAINT sessions_pkey PRIMARY KEY (id),
  CONSTRAINT sessions_class_type_id_fkey FOREIGN KEY (class_type_id) REFERENCES public.class_types(id),
  CONSTRAINT sessions_room_id_fkey FOREIGN KEY (room_id) REFERENCES public.rooms(id),
  CONSTRAINT sessions_instructor_id_fkey FOREIGN KEY (instructor_id) REFERENCES public.instructors(id),
  CONSTRAINT sessions_course_id_fkey FOREIGN KEY (course_id) REFERENCES public.courses(id)
);
CREATE TABLE public.staff (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  auth_user_id uuid UNIQUE,
  full_name text NOT NULL,
  email text UNIQUE,
  phone text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  last_login_at timestamp with time zone,
  role_id uuid NOT NULL,
  CONSTRAINT staff_pkey PRIMARY KEY (id),
  CONSTRAINT staff_auth_user_id_fkey FOREIGN KEY (auth_user_id) REFERENCES auth.users(id),
  CONSTRAINT staff_role_id_fkey FOREIGN KEY (role_id) REFERENCES public.staff_roles(id)
);
CREATE TABLE public.staff_role_permissions (
  role_id uuid NOT NULL,
  permission_id uuid NOT NULL,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT staff_role_permissions_pkey PRIMARY KEY (role_id, permission_id),
  CONSTRAINT staff_role_permissions_role_id_fkey FOREIGN KEY (role_id) REFERENCES public.staff_roles(id),
  CONSTRAINT staff_role_permissions_permission_id_fkey FOREIGN KEY (permission_id) REFERENCES public.admin_permissions(id)
);
CREATE TABLE public.staff_roles (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  slug text NOT NULL UNIQUE,
  name text NOT NULL,
  description text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT staff_roles_pkey PRIMARY KEY (id)
);